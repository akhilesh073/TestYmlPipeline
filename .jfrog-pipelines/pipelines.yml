name: cypress
configuration:
  integrations:
    - name: entArt
  nodePool: pipelines_u20
  inputResources:
    - name: cypressTest
steps:
  - name: cypress_e2e
    type: Bash
    configuration:
      runtime:
        type: image
        image:
          custom:
            name: cypress/browsers
            tag: node14.16.0-chrome89-ff86
      inputResources:
        - name: cypress_gitRepo
    execution:
      onStart:
        - node -v
        - pushd $res_cypress_gitRepo_resourcePath
        - ls -la
        - cd services/frontend/e2e
        - ls -la
        - mkdir -p /tmp/npm_cache
        - restore_pipeline_files npm_cache /tmp/npm_cache/
        - jfrog rt npmc --server-id-resolve entArt --repo-resolve npm-virtual
        - >-
          jfrog rt npmci --cache /tmp/npm_cache --prefer-offline
          --only=production
        - add_pipeline_files /tmp/npm_cache npm_cache
        - export CYPRESS_BASE_URL="$res_cypressTest_URL"
        - ls -la
        - cat cypress.json
        - 'npm run cypress:run'
        - popd
