resources:
  - name: triggerLightWeightAutomation
    type: PropertyBag
    configuration:
      jpdUrl: ''
      joinKey: ''
      branchPipelinesVersion: ''
  - name: environmentSetupBag
    type: PropertyBag
    configuration:
      pipelinesVersion: ''
      serverName: ''
      masterKey: ''
  - name: environmentOperateBag
    type: PropertyBag
    configuration:
      pipelinesVersion: ''
      serverName: ''
  - name: branchSnapshotBag
    type: PropertyBag
    configuration:
      snapshotVersion: ''
  - name: cpGit
    type: GitRepo
    configuration:
      path: akhilesh073/TestYmlPipeline
      gitProvider: testInt
name: branch_automation_setup
configuration:
  environmentVariables:
    readOnly:
      NAMESPACE_PREFIX:
        allowCustom: true
        default: p
      ADMIN_USER: admin
      ADMIN_PASSWORD: password
steps:
  - name: decide_whether_to_create_or_update_dev2cloud
    type: Bash
    configuration:
      integrations:
        - name: entArt
        - name: dockerDotJfrog
      inputResources:
        - name: branchSnapshotBag
        - name: cpGit
          trigger: true
      outputResources:
        - name: environmentSetupBag
        - name: environmentOperateBag
        - name: triggerLightWeightAutomation
    execution:
      onExecute:
        - printenv
  - name: branch_environment_setup
    type: Jenkins
    configuration:
      inputResources:
        - name: environmentSetupBag
      integrations:
        - name: jenkins_entplus_ci
      jenkinsJobName: tools/platform/environment_setup
      buildParameters:
        SERVER_NAME: '${res_environmentSetupBag_serverName}'
        ACCOUNT_TYPE: enterprise_plus
        GROUP: PIPELINES
        EXPIRY: 2w
        XRAY: 'false'
        PIPELINES: 'true'
        JFMC: 'false'
        DISTRIBUTION: 'false'
        INSIGHT: 'false'
        DEPLOYMENT_TYPE: onprem
        REGION: dev-aps1
        DEBUG_ENVIRONMENT: 'false'
        LOGS_TO_KIBANA: 'true'
        EXTRA_PARAMS: >-
          master_key=${res_environmentSetupBag_masterKey}

          pipelines_signed_pipelines_enabled=true

          conf_pipelines_chart_version=${res_environmentSetupBag_chartVersion}

          conf_pipelines_unified_version=${res_environmentSetupBag_pipelinesVersion}

          chart_app_version_unalignment_enabled=true

          artifactory_special_properties=staging.mode=true

          feature_jfconnect_enabled=False

          whitelist_cidr=20.184.243.216/32;146.148.8.199/32;104.192.136.0/21;185.166.140.0/22;18.205.93.0/25;18.234.32.128/25;13.52.5.0/25;34.74.90.64/28;34.74.226.0/24;13.52.5.96/28;13.236.8.224/28;18.136.214.96/28;18.184.99.224/28;18.234.32.224/28;18.246.31.224/28;52.215.192.224/28;104.192.137.240/28;104.192.138.240/28;104.192.140.240/28;104.192.142.240/28;104.192.143.240/28;185.166.143.240/28;185.166.142.240/28

          pipelines_auth_token=Testing1234

          pipelines_rabbitmq_persistence_enabled=true

          pipelines_api_url_enabled=false
  - name: branch_environment_operate
    type: Jenkins
    configuration:
      inputResources:
        - name: environmentOperateBag
      integrations:
        - name: jenkins_entplus_ci
      jenkinsJobName: tools/platform/environment_operate
      buildParameters:
        SERVER_NAME: '${res_environmentOperateBag_serverName}'
        EXPIRY: 2w
        ACTION: upgrade
        EXTRA_PARAMS: >-
          conf_pipelines_unified_version=${res_environmentOperateBag_pipelinesVersion}

          chart_app_version_unalignment_enabled=true

          conf_pipelines_chart_version=${res_environmentOperateBag_chartVersion}

          artifactory_special_properties=staging.mode=true

          feature_jfconnect_enabled=False

          pipelines_api_url_enabled=false
  - name: branch_environment_status
    type: Bash
    configuration:
      integrations:
        - name: pipelines_mqtest_slack
      inputResources:
        - name: environmentSetupBag
          trigger: true
        - name: environmentOperateBag
          trigger: true
      inputSteps:
        - name: branch_environment_setup
          status:
            - timeout
            - skipped
            - success
            - failure
        - name: branch_environment_operate
          status:
            - timeout
            - skipped
            - success
            - failure
        - name: decide_whether_to_create_or_update_dev2cloud
          status:
            - failure
            - success
      outputResources:
        - name: triggerLightWeightAutomation
    execution:
      onExecute:
        - printenv
